---
- name: Install Kubernetes components
  block:
    - name: Add Kubernetes apt repository
      apt_repository:
        repo: "{{ item.repo }}"
        state: present
        filename: "{{ item.filename }}"
      loop:
        - { repo: "deb http://download.opensuse.org/repositories/devel:/kubic:/libcontainers:/stable/{{ ansible_distribution | lower }}/", filename: "devel:kubic:libcontainers:stable.list" }
        - { repo: "deb http://download.opensuse.org/repositories/devel:/kubic:/libcontainers:/stable:/cri-o:/{{ kubernetes_version | regex_replace('\\.', '') }}/{{ ansible_distribution | lower }}/", filename: "devel:kubic:libcontainers:stable:cri-o:{{ kubernetes_version | regex_replace('\\.', '') }}.list" }

    - name: Import the GPG key for Kubernetes
      apt_key:
        url: "https://packages.cloud.google.com/apt/doc/apt-key.gpg"
        state: present

    - name: Install Kubernetes packages
      apt:
        name: "{{ item }}"
        state: present
      loop:
        - kubelet
        - kubectl
        - kubeadm
  tags: kubernetes